server {
  listen 80;
  # Support local and staging domains
  server_name customer.local stg.customer.feed-intel.com customer.feed-intel.com;

  # ACME HTTP-01 challenge (Let's Encrypt)
  location ^~ /.well-known/acme-challenge/ {
    alias /var/www/certbot/.well-known/acme-challenge/;
    default_type text/plain;
    access_log off;
  }

  # Serve static customer web export. Root at /customer, fallback to /customer/client
  root /usr/share/nginx/html/customer;
  index index.html;
  autoindex off;

  # Serve SPA index for root explicitly (avoids 403 when directory has no index)
  location = / {
    try_files /client/index.html /index.html =404;
  }

  # Primary SPA route: try path, then fallback to SPA index
  location / {
    try_files $uri $uri/ /client/index.html /index.html;
  }

  # Static assets under client (typical Expo export layout)
  location ^~ /assets/ {
    alias /usr/share/nginx/html/customer/client/assets/;
    access_log off;
    expires 7d;
    try_files $uri =404;
  }

  # Common static file types anywhere under root
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    access_log off;
    expires 7d;
    try_files $uri =404;
  }
}

# HTTPS for Customer (staging)
server {
  listen 443 ssl http2;
  server_name stg.customer.feed-intel.com;

  ssl_certificate     /etc/nginx/tls/stg.customer.feed-intel.com/fullchain.pem;
  ssl_certificate_key /etc/nginx/tls/stg.customer.feed-intel.com/privkey.pem;
  ssl_session_cache off;
  ssl_protocols TLSv1.2 TLSv1.3;

  root /usr/share/nginx/html/customer;
  index index.html;
  autoindex off;

  location = / {
    try_files /client/index.html /index.html =404;
  }

  location / {
    try_files $uri $uri/ /client/index.html /index.html;
  }

  location ^~ /assets/ {
    alias /usr/share/nginx/html/customer/client/assets/;
    access_log off;
    expires 7d;
    try_files $uri =404;
  }

  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    access_log off;
    expires 7d;
    try_files $uri =404;
  }
}
