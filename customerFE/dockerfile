# Stage 1: Build the Expo web app
FROM node:23-alpine AS builder

# Set working directory
WORKDIR /app

# Runtime build-time variables must be provided by the build environment.
# Avoid committing secrets or production URLs into the image.
ARG EXPO_PUBLIC_API_URL
ARG EXPO_PUBLIC_BACKEND_URL
ARG EXPO_PUBLIC_API_KEY
ARG EXPO_PUBLIC_DOMAIN
ARG EXPO_PUBLIC_WS_URL
ARG EXPO_PUBLIC_BASE_URL
ARG EXPO_PUBLIC_GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG FACEBOOK_CLIENT_ID
ARG FACEBOOK_CLIENT_SECRET
ARG EXPO_PUBLIC_CHAPA_CHECKOUT_URL
ARG EXPO_PUBLIC_TELEBIRR_API
ARG EXPO_PUBLIC_TELEBIRR_APPSECRET
ARG EXPO_PUBLIC_FABRIC_ID
ARG EXPO_PUBLIC_PRIVATEKEY
ARG EXPO_PUBLIC_MERCHANT_APPID
ARG EXPO_PUBLIC_MERCHANT_SHORTCODE
ARG EXPO_PUBLIC_SCHEME

ENV EXPO_PUBLIC_API_URL=${EXPO_PUBLIC_API_URL} \
    EXPO_PUBLIC_BACKEND_URL=${EXPO_PUBLIC_BACKEND_URL} \
    EXPO_PUBLIC_API_KEY=${EXPO_PUBLIC_API_KEY} \
    EXPO_PUBLIC_DOMAIN=${EXPO_PUBLIC_DOMAIN} \
    EXPO_PUBLIC_WS_URL=${EXPO_PUBLIC_WS_URL} \
    EXPO_PUBLIC_BASE_URL=${EXPO_PUBLIC_BASE_URL} \
    EXPO_PUBLIC_GOOGLE_CLIENT_ID=${EXPO_PUBLIC_GOOGLE_CLIENT_ID} \
    GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} \
    FACEBOOK_CLIENT_ID=${FACEBOOK_CLIENT_ID} \
    FACEBOOK_CLIENT_SECRET=${FACEBOOK_CLIENT_SECRET} \
    EXPO_PUBLIC_CHAPA_CHECKOUT_URL=${EXPO_PUBLIC_CHAPA_CHECKOUT_URL} \
    EXPO_PUBLIC_TELEBIRR_API=${EXPO_PUBLIC_TELEBIRR_API} \
    EXPO_PUBLIC_TELEBIRR_APPSECRET=${EXPO_PUBLIC_TELEBIRR_APPSECRET} \
    EXPO_PUBLIC_FABRIC_ID=${EXPO_PUBLIC_FABRIC_ID} \
    EXPO_PUBLIC_PRIVATEKEY=${EXPO_PUBLIC_PRIVATEKEY} \
    EXPO_PUBLIC_MERCHANT_APPID=${EXPO_PUBLIC_MERCHANT_APPID} \
    EXPO_PUBLIC_MERCHANT_SHORTCODE=${EXPO_PUBLIC_MERCHANT_SHORTCODE} \
    EXPO_PUBLIC_SCHEME=${EXPO_PUBLIC_SCHEME}

# Install dependencies
COPY package.json ./
RUN npm install

# Install Expo CLI
RUN yarn global add expo-cli

# Copy the rest of the application
COPY . .

# Build the static web app
RUN npx expo export --platform web

# Run the production server on port 3001
EXPOSE 3001
CMD ["npx", "expo", "serve", "--port", "3001"]
