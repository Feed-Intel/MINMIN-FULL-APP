# Stage 1: Build the Expo web app
FROM node:23-alpine AS builder

# Set working directory
WORKDIR /app

# Runtime build-time variables must be provided by the build environment.
# Avoid committing secrets or production URLs into the image.
ARG EXPO_PUBLIC_API_URL
ARG EXPO_PUBLIC_BACKEND_URL
ARG EXPO_PUBLIC_DOMAIN
ARG EXPO_PUBLIC_WS_URL
ARG EXPO_PUBLIC_BASE_URL

ENV EXPO_PUBLIC_API_URL=${EXPO_PUBLIC_API_URL} \
    EXPO_PUBLIC_BACKEND_URL=${EXPO_PUBLIC_BACKEND_URL} \
    EXPO_PUBLIC_DOMAIN=${EXPO_PUBLIC_DOMAIN} \
    EXPO_PUBLIC_WS_URL=${EXPO_PUBLIC_WS_URL} \
    EXPO_PUBLIC_BASE_URL=${EXPO_PUBLIC_BASE_URL}

# Install dependencies
COPY package.json ./
RUN npm install

# Install Expo CLI
RUN yarn global add expo-cli

# Copy the rest of the application
COPY . .

# Build the static web app
RUN npx expo export --platform web

# Run the production server on port 3000
EXPOSE 3000
CMD ["npx", "expo", "serve", "--port", "3001"]
